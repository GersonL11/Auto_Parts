"use strict";var Venta=require("../models/Venta"),Repuesto=require("../models/Repuesto"),VentaLeida=require("../models/VentaLeida"),Movimiento=require("../models/Movimiento");exports.crearVenta=function(r,t){var n,a,s,o,c,u,i,d,p,l,m,f,v,x,b,g,h,w,k,j,V;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=r.body.carrito||[],s=!(a=!0),o=void 0,e.prev=5,c=n[Symbol.iterator]();case 7:if(a=(u=c.next()).done){e.next=21;break}if((i=u.value)._id){e.next=11;break}return e.abrupt("return",t.status(400).json({error:"Falta el _id del repuesto en el carrito"}));case 11:return e.next=13,regeneratorRuntime.awrap(Repuesto.findById(i._id));case 13:if(d=e.sent){e.next=16;break}return e.abrupt("return",t.status(400).json({error:"Repuesto no encontrado: ".concat(i.nombre)}));case 16:if(d.cantidad<i.cantidad)return e.abrupt("return",t.status(400).json({error:"Stock insuficiente para: ".concat(i.nombre)}));e.next=18;break;case 18:a=!0,e.next=7;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(5),s=!0,o=e.t0;case 27:e.prev=27,e.prev=28,a||null==c.return||c.return();case 30:if(e.prev=30,s)throw o;e.next=33;break;case 33:return e.finish(30);case 34:return e.finish(27);case 35:l=!(p=!0),m=void 0,e.prev=38,f=n[Symbol.iterator]();case 40:if(p=(v=f.next()).done){e.next=47;break}return x=v.value,e.next=44,regeneratorRuntime.awrap(Repuesto.findByIdAndUpdate(x._id,{$inc:{cantidad:-x.cantidad}}));case 44:p=!0,e.next=40;break;case 47:e.next=53;break;case 49:e.prev=49,e.t1=e.catch(38),l=!0,m=e.t1;case 53:e.prev=53,e.prev=54,p||null==f.return||f.return();case 56:if(e.prev=56,l)throw m;e.next=59;break;case 59:return e.finish(56);case 60:return e.finish(53);case 61:return b=new Venta(r.body),e.next=64,regeneratorRuntime.awrap(b.save());case 64:h=!(g=!0),w=void 0,e.prev=67,k=n[Symbol.iterator]();case 69:if(g=(j=k.next()).done){e.next=76;break}return V=j.value,e.next=73,regeneratorRuntime.awrap(Movimiento.create({repuesto:V._id,tipo:"Salida",cantidad:V.cantidad,fecha:new Date,descripcion:"Venta de ".concat(V.nombre," (").concat(V.marca||""," ").concat(V.modelo||"",") x").concat(V.cantidad)}));case 73:g=!0,e.next=69;break;case 76:e.next=82;break;case 78:e.prev=78,e.t2=e.catch(67),h=!0,w=e.t2;case 82:e.prev=82,e.prev=83,g||null==k.return||k.return();case 85:if(e.prev=85,h)throw w;e.next=88;break;case 88:return e.finish(85);case 89:return e.finish(82);case 90:t.status(201).json(b),e.next=96;break;case 93:e.prev=93,e.t3=e.catch(0),t.status(400).json({error:e.t3.message});case 96:case"end":return e.stop()}},null,null,[[0,93],[5,23,27,35],[28,,30,34],[38,49,53,61],[54,,56,60],[67,78,82,90],[83,,85,89]])},exports.obtenerVentas=function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Venta.find());case 3:t=e.sent,r.json(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({error:e.t0.message});case 10:case"end":return e.stop()}},null,null,[[0,7]])},exports.obtenerVentaPorId=function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Venta.findById(r.params.id));case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({error:"Venta no encontrada"}));case 6:t.json(n),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).json({error:e.t0.message});case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.actualizarVenta=function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Venta.findByIdAndUpdate(r.params.id,r.body,{new:!0}));case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({error:"Venta no encontrada"}));case 6:t.json(n),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).json({error:e.t0.message});case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.eliminarVenta=function(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Venta.findByIdAndDelete(r.params.id));case 3:if(e.sent){e.next=6;break}return e.abrupt("return",t.status(404).json({error:"Venta no encontrada"}));case 6:t.json({mensaje:"Venta eliminada"}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).json({error:e.t0.message});case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.marcarVentaLeida=function(r,t){var n,a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.body,a=n.ventaId,s=n.adminId,a&&s){e.next=4;break}return e.abrupt("return",t.status(400).json({error:"Faltan parÃ¡metros"}));case 4:return e.next=6,regeneratorRuntime.awrap(VentaLeida.findOneAndUpdate({ventaId:a,adminId:s},{leida:!0,fecha:new Date},{upsert:!0,new:!0}));case 6:t.json({ok:!0}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(400).json({error:e.t0.message});case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.obtenerVentasLeidasPorAdmin=function(r,t){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.query.adminId){e.next=4;break}return e.abrupt("return",t.status(400).json({error:"Falta adminId"}));case 4:return e.next=6,regeneratorRuntime.awrap(VentaLeida.find({adminId:n,leida:!0}).select("ventaId -_id"));case 6:a=e.sent,t.json(a.map(function(e){return e.ventaId})),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),t.status(400).json({error:e.t0.message});case 13:case"end":return e.stop()}},null,null,[[0,10]])},exports.obtenerVentasPorMes=function(e,r){var t,n,a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=new Date,n=t.getFullYear(),e.next=5,regeneratorRuntime.awrap(Venta.aggregate([{$match:{fecha:{$gte:new Date("".concat(n,"-01-01T00:00:00.000Z")),$lte:new Date("".concat(n,"-12-31T23:59:59.999Z"))}}},{$group:{_id:{$month:"$fecha"},cantidad:{$sum:1}}}]));case 5:a=e.sent,s=Array(12).fill(0),a.forEach(function(e){s[e._id-1]=e.cantidad}),r.json({valores:s}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),r.status(500).json({error:e.t0.message});case 14:case"end":return e.stop()}},null,null,[[0,11]])},exports.obtenerVentasPorCliente=function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Venta.aggregate([{$group:{_id:{$ifNull:["$cliente","Sin nombre"]},total:{$sum:"$total"}}},{$sort:{total:-1}},{$limit:10}]));case 3:t=e.sent,r.json({labels:t.map(function(e){return e._id||"Sin nombre"}),valores:t.map(function(e){return e.total})}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({error:e.t0.message});case 10:case"end":return e.stop()}},null,null,[[0,7]])};
//# sourceMappingURL=venta.controller.min.js.map
